@page "/children/{id:guid}"
@attribute [StreamRendering]
@rendermode InteractiveServer

@using System.Globalization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Картка дитини</PageTitle>

@if (isLoading)
{
    <p><em>Завантаження...</em></p>
}
else if (child is null)
{
    <div class="alert alert-danger">
        Дитину з таким ідентифікатором не знайдено.
    </div>
}
else
{
    <h1>Картка дитини</h1>

    <div class="card mb-4">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">
                    @(isEditMode ? "Редагування даних дитини" : child.FullName)
                </h4>

                @if (!isEditMode)
                {
                    <button class="btn btn-outline-primary btn-sm" @onclick="BeginEdit">
                        Редагувати
                    </button>
                }
            </div>

            @if (isEditMode)
            {
                <EditForm Model="@editModel" OnValidSubmit="@SaveEdit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label class="form-label">ПІБ дитини</label>
                        <InputText class="form-control" @bind-Value="editModel.FullName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Дата народження</label>
                        <InputDate class="form-control"
                                   @bind-Value="editModel.BirthDate" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Країна перебування</label>
                        <InputText class="form-control" @bind-Value="editModel.Country" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Опікун</label>
                        <InputText class="form-control" @bind-Value="editModel.Guardian" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Статус</label>
                        <InputText class="form-control" @bind-Value="editModel.Status" />
                    </div>

                    <button type="submit" class="btn btn-primary me-2">Зберегти</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                        Скасувати
                    </button>
                </EditForm>
            }
            else
            {
                <dl class="row mb-0">
                    <dt class="col-sm-3">ChildID</dt>
                    <dd class="col-sm-9">@child.ChildID</dd>

                    <dt class="col-sm-3">Дата народження</dt>
                    <dd class="col-sm-9">@child.BirthDate.ToString("dd.MM.yyyy")</dd>

                    <dt class="col-sm-3">Країна перебування</dt>
                    <dd class="col-sm-9">@child.Country</dd>

                    <dt class="col-sm-3">Опікун</dt>
                    <dd class="col-sm-9">@child.Guardian</dd>

                    <dt class="col-sm-3">Статус</dt>
                    <dd class="col-sm-9">@child.Status</dd>
                </dl>
            }
        </div>
    </div>

    <div class="mb-3">
        <a class="btn btn-secondary btn-sm" href="/children">
            ← Повернутися до списку дітей
        </a>
        @if (documents.Any())
        {
            <a class="btn btn-outline-primary btn-sm ms-2"
               href="@($"/children/{child.ChildID}/documents")">
                Усі документи дитини
            </a>
        }
    </div>

    <h3>Документи, приєднані до дитини</h3>

    @if (!documents.Any())
    {
        <p>Для цієї дитини поки що немає документів.</p>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-3 g-3">
            @foreach (var doc in documents)
            {
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">@doc.Title</h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                                @string.Join(", ", doc.FileTypes)
                            </h6>

                            <p class="card-text mb-1">
                                <strong>Дата документа:</strong>
                                @doc.IssueDate.ToString("dd.MM.yyyy")
                            </p>
                            <p class="card-text mb-1">
                                <strong>Статус:</strong> @doc.Status
                            </p>
                            <p class="card-text">
                                <strong>Номер:</strong> @doc.ReferenceNumber
                            </p>
                        </div>
                        <div class="card-footer bg-transparent border-0">
                            <a class="btn btn-outline-primary btn-sm"
                               href="@($"/documents/{doc.DocumentId}")">
                                Перейти до документа
                            </a>

                            @if (doc.Status == "На підпис")
                            {
                                <button class="btn btn-success btn-sm ms-2"
                                        @onclick="() => SignDocument(doc)">
                                    Підписати
                                </button>
                            }

                            @if (doc.Status == "Підписано")
                            {
                                <button class="btn btn-warning btn-sm ms-2"
                                        @onclick="() => OpenSendDialog(doc)">
                                    Надіслати
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @* Модальне вікно для надсилання документа *@
    @if (isSendDialogOpen && documentToSend is not null)
    {
        <div class="modal fade show d-block" tabindex="-1"
             style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Надіслати документ</h5>
                        <button type="button" class="btn-close" @onclick="CloseSendDialog"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Документ:</strong> @documentToSend.Title</p>

                        <div class="mb-3">
                            <label class="form-label">Назва / ім'я адресата</label>
                            <input class="form-control" @bind="recipientName" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email адресата</label>
                            <input class="form-control" @bind="recipientEmail" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseSendDialog">
                            Скасувати
                        </button>
                        <button class="btn btn-primary" @onclick="ConfirmSend">
                            Надіслати
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter] public Guid Id { get; set; }

    private bool isLoading = true;
    private Child? child;
    private List<Document> documents = new();

    // --- Редагування дитини ---
    private bool isEditMode = false;
    private Child editModel = new();

    // --- Стан модального вікна "Надіслати" ---
    private bool isSendDialogOpen = false;
    private Document? documentToSend;
    private string recipientName = string.Empty;
    private string recipientEmail = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        await Task.Delay(300);

        var allChildren = GetTestChildren();
        child = allChildren.FirstOrDefault(c => c.ChildID == Id);

        if (child is not null)
        {
            documents = GetTestDocumentsForChild(child);
        }

        isLoading = false;
    }

    // --- Редагування ---

    private void BeginEdit()
    {
        if (child is null)
            return;

        editModel = new Child
        {
            ChildID = child.ChildID,
            FullName = child.FullName,
            BirthDate = child.BirthDate,
            Country = child.Country,
            Guardian = child.Guardian,
            Status = child.Status
        };

        isEditMode = true;
    }

    private void SaveEdit()
    {
        if (child is null)
            return;

        child.FullName = editModel.FullName;
        child.BirthDate = editModel.BirthDate;
        child.Country = editModel.Country;
        child.Guardian = editModel.Guardian;
        child.Status = editModel.Status;

        isEditMode = false;
    }

    private void CancelEdit()
    {
        isEditMode = false;
    }

    // --- КНОПКА "Підписати" ---

    private void SignDocument(Document doc)
    {
        doc.Status = "Підписано";

        if (!doc.FileTypes.Contains(".p7s", StringComparer.OrdinalIgnoreCase))
        {
            doc.FileTypes.Add(".p7s");
        }
    }

    // --- Надіслати документ ---

    private void OpenSendDialog(Document doc)
    {
        documentToSend = doc;
        recipientName = string.Empty;
        recipientEmail = string.Empty;
        isSendDialogOpen = true;
    }

    private void CloseSendDialog()
    {
        isSendDialogOpen = false;
        documentToSend = null;
    }

    private void ConfirmSend()
    {
        if (documentToSend is not null)
        {
            documentToSend.Status = "Надісланий";
        }

        isSendDialogOpen = false;
        documentToSend = null;
        recipientName = string.Empty;
        recipientEmail = string.Empty;
    }

    // --- Тестові дані дітей ---

    private static List<Child> GetTestChildren() => new()
    {
        new Child
        {
            ChildID = Guid.Parse("9681b2a1-6566-4e3a-84cc-7f43c480c28b"),
            FullName = "Іван Петренко",
            BirthDate = new DateOnly(2015, 3, 12),
            Country = "Німеччина",
            Guardian = "Олена Петренко",
            Status = "Під наглядом органів опіки"
        },
        new Child
        {
            ChildID = Guid.Parse("957d06e5-9785-4d12-a5b8-c67ad5ee6968"),
            FullName = "Марія Іванчук",
            BirthDate = new DateOnly(2014, 7, 25),
            Country = "Польща",
            Guardian = "Сергій Іванчук",
            Status = "Сімейне влаштування"
        },
        new Child
        {
            ChildID = Guid.Parse("41841f69-f3a6-4478-b616-23bca0dbb01d"),
            FullName = "Андрій Коваленко",
            BirthDate = new DateOnly(2012, 11, 3),
            Country = "Чехія",
            Guardian = "Наталія Коваленко",
            Status = "Потребує уточнення даних"
        },
        new Child
        {
            ChildID = Guid.Parse("744b02b2-81fe-4f82-9e4d-127ebf110d36"),
            FullName = "Олександра Романюк",
            BirthDate = new DateOnly(2016, 1, 18),
            Country = "Італія",
            Guardian = "Ірина Романюк",
            Status = "Під наглядом соціальних служб"
        },
        new Child
        {
            ChildID = Guid.Parse("235f0ed7-3703-4b35-a620-41e1495d0986"),
            FullName = "Дмитро Савченко",
            BirthDate = new DateOnly(2013, 5, 9),
            Country = "Іспанія",
            Guardian = "Олексій Савченко",
            Status = "Влаштований у прийомну сім'ю"
        },
        new Child
        {
            ChildID = Guid.Parse("389c06ea-eada-4934-9107-4cb422f58158"),
            FullName = "Катерина Шевченко",
            BirthDate = new DateOnly(2017, 9, 2),
            Country = "Франція",
            Guardian = "Ганна Шевченко",
            Status = "Під тимчасовою опікою"
        },
        new Child
        {
            ChildID = Guid.Parse("e998e1ef-9fc3-4bb6-ab2a-f71df0b3047d"),
            FullName = "Микита Бондар",
            BirthDate = new DateOnly(2011, 12, 30),
            Country = "Нідерланди",
            Guardian = "Оксана Бондар",
            Status = "Повернення в Україну планується"
        },
        new Child
        {
            ChildID = Guid.Parse("01cfba80-f70a-43fa-b89b-ac9d067554b9"),
            FullName = "Софія Лисенко",
            BirthDate = new DateOnly(2015, 4, 7),
            Country = "Німеччина",
            Guardian = "Ігор Лисенко",
            Status = "Під наглядом органів опіки"
        },
        new Child
        {
            ChildID = Guid.Parse("ce73dd3c-b108-4c25-9883-835d30d95254"),
            FullName = "Богдан Ткаченко",
            BirthDate = new DateOnly(2010, 10, 15),
            Country = "Польща",
            Guardian = "Людмила Ткаченко",
            Status = "Сімейне влаштування"
        },
        new Child
        {
            ChildID = Guid.Parse("ce5dd69c-e2ce-4215-a551-e49aeab2adbe"),
            FullName = "Олена Гриценко",
            BirthDate = new DateOnly(2013, 2, 21),
            Country = "Чехія",
            Guardian = "Роман Гриценко",
            Status = "Потребує уточнення даних"
        },
        new Child
        {
            ChildID = Guid.Parse("4cf42519-7f92-4225-8fd4-ec02da5a6fff"),
            FullName = "Руслан Деркач",
            BirthDate = new DateOnly(2012, 6, 6),
            Country = "Італія",
            Guardian = "Світлана Деркач",
            Status = "Під наглядом соціальних служб"
        },
        new Child
        {
            ChildID = Guid.Parse("6d4080c7-26e3-4c22-a135-2c9398131dfd"),
            FullName = "Вероніка Черненко",
            BirthDate = new DateOnly(2016, 8, 19),
            Country = "Іспанія",
            Guardian = "Віктор Черненко",
            Status = "Влаштована у прийомну сім'ю"
        },
        new Child
        {
            ChildID = Guid.Parse("71d1117f-346e-4a09-8d39-3dea5fbdc567"),
            FullName = "Тарас Клименко",
            BirthDate = new DateOnly(2014, 1, 9),
            Country = "Франція",
            Guardian = "Марія Клименко",
            Status = "Під тимчасовою опікою"
        },
        new Child
        {
            ChildID = Guid.Parse("bb0fbb6b-a587-4841-89e2-bf2e0a9b2d12"),
            FullName = "Лілія Сидоренко",
            BirthDate = new DateOnly(2011, 3, 27),
            Country = "Нідерланди",
            Guardian = "Олег Сидоренко",
            Status = "Повернення в Україну планується"
        },
        new Child
        {
            ChildID = Guid.Parse("41d970e9-e2d8-42a8-838a-814b2efb87db"),
            FullName = "Юрій Павленко",
            BirthDate = new DateOnly(2013, 7, 14),
            Country = "Німеччина",
            Guardian = "Інна Павленко",
            Status = "Під наглядом органів опіки"
        },
        new Child
        {
            ChildID = Guid.Parse("bf97ad5a-ddc2-4248-b3a8-4bde634d2869"),
            FullName = "Ірина Омельченко",
            BirthDate = new DateOnly(2012, 9, 5),
            Country = "Польща",
            Guardian = "Василь Омельченко",
            Status = "Сімейне влаштування"
        },
        new Child
        {
            ChildID = Guid.Parse("6cc9d9e1-ba72-453e-952e-9817aeca3cf1"),
            FullName = "Максим Кравчук",
            BirthDate = new DateOnly(2015, 12, 1),
            Country = "Чехія",
            Guardian = "Галина Кравчук",
            Status = "Потребує уточнення даних"
        },
        new Child
        {
            ChildID = Guid.Parse("52237cf2-96fb-4df8-8892-19ca5b5a710c"),
            FullName = "Оксана Білик",
            BirthDate = new DateOnly(2010, 4, 11),
            Country = "Італія",
            Guardian = "Петро Білик",
            Status = "Під наглядом соціальних служб"
        },
        new Child
        {
            ChildID = Guid.Parse("25d40e24-1ed0-4c02-a73d-759654f79fa7"),
            FullName = "Роман Козак",
            BirthDate = new DateOnly(2016, 6, 23),
            Country = "Іспанія",
            Guardian = "Надія Козак",
            Status = "Влаштований у прийомну сім'ю"
        },
        new Child
        {
            ChildID = Guid.Parse("55c16866-6804-41da-b9d4-715ec39d2b39"),
            FullName = "Аліна Левченко",
            BirthDate = new DateOnly(2014, 2, 4),
            Country = "Франція",
            Guardian = "Юлія Левченко",
            Status = "Під тимчасовою опікою"
        }
    };

    // --- Тестові документи для дитини ---

    private static List<Document> GetTestDocumentsForChild(Child child)
    {
        var baseDate = new DateOnly(2024, 5, 1);

        return new List<Document>
        {
            new Document
            {
                DocumentId = Guid.NewGuid(),
                ChildId = child.ChildID,
                Title = "Рішення органу опіки про тимчасове влаштування",
                FileTypes = new() { "PDF" },
                IssueDate = baseDate,
                Status = "Чинний",
                ReferenceNumber = $"OP-{child.BirthDate.Year}-{child.ChildID.ToString()[..8]}"
            },
            new Document
            {
                DocumentId = Guid.NewGuid(),
                ChildId = child.ChildID,
                Title = "Акт обстеження умов проживання",
                FileTypes = new() { "DOCX" },
                IssueDate = baseDate.AddDays(7),
                Status = "На підпис",
                ReferenceNumber = $"ACT-{child.BirthDate.Month:00}-{child.BirthDate.Day:00}"
            },
            new Document
            {
                DocumentId = Guid.NewGuid(),
                ChildId = child.ChildID,
                Title = "Повідомлення компетентного органу держави перебування",
                FileTypes = new() { "PDF" },
                IssueDate = baseDate.AddDays(30),
                Status = "Архівний",
                ReferenceNumber = $"INF-{child.Country[..Math.Min(3, child.Country.Length)].ToUpper()}-{child.BirthDate:yyyy}"
            }
        };
    }

    // --- Моделі ---

    private class Child
    {
        public Guid ChildID { get; set; }
        public string FullName { get; set; } = string.Empty;
        public DateOnly BirthDate { get; set; }
        public string Country { get; set; } = string.Empty;
        public string Guardian { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
    }

    private class Document
    {
        public Guid DocumentId { get; set; }
        public Guid ChildId { get; set; }
        public string Title { get; set; } = string.Empty;
        public List<string> FileTypes { get; set; } = new();
        public DateOnly IssueDate { get; set; }
        public string Status { get; set; } = string.Empty;
        public string ReferenceNumber { get; set; } = string.Empty;
    }
}
